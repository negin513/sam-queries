{% import 'dashboards/status/partials/system_header.html' as header %}
{% import 'dashboards/status/partials/metric_card.html' as metric %}
{% import 'dashboards/status/partials/no_data_message.html' as empty %}

{% if jupyterhub_status %}
<div class="card mb-3">
    {{ header.system_header('<i class="fas fa-rocket"></i> JupyterHub Status', jupyterhub_status.timestamp) }}
    <div class="card-body">
        <!-- At a Glance -->
        <h5 class="mb-3"><i class="fas fa-eye"></i> At a Glance</h5>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border h-100">
                    <div class="card-body text-center d-flex flex-column justify-content-center">
                        <div class="mb-3">
                            {% if jupyterhub_status.available %}
                            <i class="fas fa-check-circle text-success" style="font-size: 70px;"></i>
                            {% else %}
                            <i class="fas fa-times-circle text-danger" style="font-size: 70px;"></i>
                            {% endif %}
                        </div>
                        <h6 class="text-muted mb-1">Service Status</h6>
                        <div class="h5 mb-0">{{ 'Online' if jupyterhub_status.available else 'Offline' }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border h-100">
                    <div class="card-body text-center d-flex flex-column justify-content-center">
                        <div class="mb-3">
                            <i class="fas fa-users text-primary" style="font-size: 70px;"></i>
                        </div>
                        <h6 class="text-muted mb-1">Active Users</h6>
                        <div class="h5 mb-0">{{ jupyterhub_status.active_users or 0 }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border h-100">
                    <div class="card-body text-center d-flex flex-column justify-content-center">
                        <div class="mb-3">
                            <i class="fas fa-desktop text-info" style="font-size: 70px;"></i>
                        </div>
                        <h6 class="text-muted mb-1">Active Sessions</h6>
                        <div class="h5 mb-0">{{ jupyterhub_status.active_sessions or 0 }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                {% set cpus_total = jupyterhub_status.cpus_total or 0 %}
                {% set cpus_used = jupyterhub_status.cpus_used or 0 %}
                {% set total_slots = (cpus_total / 2)|int %}
                {% set used_slots = (cpus_used / 2)|int %}
                {% set available_slots = total_slots - used_slots %}
                {% set slot_percent = ((used_slots / total_slots * 100)|round)|int if total_slots > 0 else 0 %}
                <div class="card border h-100">
                    <div class="card-body text-center d-flex flex-column justify-content-center">
                        <div style="height: 70px; display: flex; flex-direction: column; justify-content: center; margin-bottom: 1rem;">
                            <div class="d-flex justify-content-end mb-1">
                                <span class="fw-bold text-{{ 'danger' if slot_percent >= 90 else 'warning' if slot_percent >= 75 else 'success' }}" style="font-size: 1.5rem;">{{ slot_percent }}%</span>
                            </div>
                            <div class="progress" style="height: 12px;">
                                <div class="progress-bar bg-{{ 'danger' if slot_percent >= 90 else 'warning' if slot_percent >= 75 else 'success' }}"
                                     role="progressbar"
                                     style="width: {{ slot_percent }}%"
                                     aria-valuenow="{{ slot_percent }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        <h6 class="text-muted mb-1">Session Capacity</h6>
                        <div class="h5 mb-0">{{ used_slots }}/{{ total_slots }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Breakouts -->
        <h5 class="mb-3"><i class="fas fa-th"></i> Session Breakouts</h5>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border h-100" style="border-left: 4px solid #198754 !important;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="text-muted mb-0">Casper Login Jobs</h6>
                            <i class="fas fa-sign-in-alt fa-2x text-success"></i>
                        </div>
                        <div class="h3 mb-0 text-success">{{ jupyterhub_status.casper_login_jobs or 0 }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border h-100" style="border-left: 4px solid #0dcaf0 !important;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="text-muted mb-0">Casper Batch Jobs</h6>
                            <i class="fas fa-layer-group fa-2x text-info"></i>
                        </div>
                        <div class="h3 mb-0 text-info">{{ jupyterhub_status.casper_batch_jobs or 0 }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border h-100" style="border-left: 4px solid #0d6efd !important;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="text-muted mb-0">Derecho Batch Jobs</h6>
                            <i class="fas fa-server fa-2x text-primary"></i>
                        </div>
                        <div class="h3 mb-0 text-primary">{{ jupyterhub_status.derecho_batch_jobs or 0 }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border h-100" style="border-left: 4px solid #ffc107 !important;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="text-muted mb-0">Broken Jobs</h6>
                            <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        </div>
                        <div class="h3 mb-0 text-warning">{{ jupyterhub_status.jobs_suspended or 0 }}</div>
                    </div>
                </div>
            </div>
        </div>

        {% if jupyterhub_status.nodes and jupyterhub_status.nodes|length > 0 %}
        <!-- Casper JupyterHub Login Sessions -->
        <h5 class="mb-3"><i class="fas fa-server"></i> Casper JupyterHub Login Sessions</h5>

        <!-- Resource Utilization -->
        <h5 class="mb-3 mt-4"><i class="fas fa-chart-bar"></i> Resource Utilization</h5>
        <div class="row mb-4">
            <div class="col-md-6">
                {% set cpus_total = jupyterhub_status.cpus_total or 0 %}
                {% set cpus_used = jupyterhub_status.cpus_used or 0 %}
                {% set cpu_percent = ((cpus_used / cpus_total * 100)|round(1))|default(0, true) if cpus_total > 0 else 0 %}
                <div class="card border h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">CPU Utilization</h6>
                            <span class="fw-bold text-{{ 'danger' if cpu_percent >= 90 else 'warning' if cpu_percent >= 75 else 'success' }}" style="font-size: 1.5rem;">
                                {{ cpu_percent }}%
                            </span>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar bg-{{ 'danger' if cpu_percent >= 90 else 'warning' if cpu_percent >= 75 else 'success' }}"
                                 role="progressbar"
                                 style="width: {{ cpu_percent }}%"
                                 aria-valuenow="{{ cpu_percent }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="text-muted">
                            {{ '{:,}'.format(cpus_used) }} / {{ '{:,}'.format(cpus_total) }} cores in use
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                {% set mem_total = jupyterhub_status.memory_total_gb or 0 %}
                {% set mem_used = jupyterhub_status.memory_used_gb or 0 %}
                {% set mem_percent = ((mem_used / mem_total * 100)|round(1))|default(0, true) if mem_total > 0 else 0 %}
                <div class="card border h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Memory Utilization</h6>
                            <span class="fw-bold text-{{ 'danger' if mem_percent >= 90 else 'warning' if mem_percent >= 75 else 'success' }}" style="font-size: 1.5rem;">
                                {{ mem_percent }}%
                            </span>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar bg-{{ 'danger' if mem_percent >= 90 else 'warning' if mem_percent >= 75 else 'success' }}"
                                 role="progressbar"
                                 style="width: {{ mem_percent }}%"
                                 aria-valuenow="{{ mem_percent }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="text-muted">
                            {{ '{:,.0f}'.format(mem_used) }} / {{ '{:,.0f}'.format(mem_total) }} GB in use
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Node Details -->
        <h5 class="mb-3 mt-4"><i class="fas fa-list"></i> Node Details</h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Node</th>
                        <th>State</th>
                        <th>Jobs</th>
                        <th>CPUs</th>
                        <th>Memory</th>
                    </tr>
                </thead>
                <tbody>
                    {% for node in jupyterhub_status.nodes|sort(attribute='name') %}
                    <tr>
                        <td><code>{{ node.name }}</code></td>
                        <td>
                            <span class="badge bg-{{ 'success' if node.state == 'free' else 'warning' if node.state == 'job-busy' else 'danger' }}">
                                {{ node.state }}
                            </span>
                        </td>
                        <td>{{ node.jobs_running }}</td>
                        <td>
                            <small>{{ node.cpus_used }}/{{ node.cpus_total }}</small>
                            <div class="progress" style="height: 8px; width: 60px;">
                                <div class="progress-bar bg-{{ 'danger' if (node.cpus_used / node.cpus_total * 100) >= 90 else 'warning' if (node.cpus_used / node.cpus_total * 100) >= 75 else 'success' }}"
                                     style="width: {{ (node.cpus_used / node.cpus_total * 100)|round }}%"></div>
                            </div>
                        </td>
                        <td>
                            <small>{{ node.memory_used_gb }}/{{ node.memory_total_gb }}GB</small>
                            <div class="progress" style="height: 8px; width: 60px;">
                                <div class="progress-bar bg-{{ 'danger' if (node.memory_used_gb / node.memory_total_gb * 100) >= 90 else 'warning' if (node.memory_used_gb / node.memory_total_gb * 100) >= 75 else 'success' }}"
                                     style="width: {{ (node.memory_used_gb / node.memory_total_gb * 100)|round }}%"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% else %}
{{ empty.no_data_message('No JupyterHub status data available.') }}
{% endif %}
